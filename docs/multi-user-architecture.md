# CUI å¤šç”¨æˆ·å¹¶å‘æ¶æ„è¯¦è§£

## ğŸ¯ æ ¸å¿ƒé—®é¢˜å›ç­”

**é—®é¢˜:** ä¸‰ä¸ªç”¨æˆ·åŒæ—¶è®¿é—®,ç³»ç»Ÿå¦‚ä½•è¿ä½œ?èƒ½å¦åŒºåˆ†ä¸åŒç”¨æˆ·çš„å¯¹è¯?æ˜¯å¦äº’ä¸å¹²æ‰°?

**ç­”æ¡ˆ:** âœ… å®Œå…¨æ”¯æŒ!æ¯ä¸ªç”¨æˆ·ã€æ¯ä¸ªå¯¹è¯éƒ½æœ‰ç‹¬ç«‹çš„è¿›ç¨‹å’Œæ ‡è¯†ç¬¦,å®Œå…¨éš”ç¦»!

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CUI Server (å•ä¸€å®ä¾‹)                          â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Auth Token: abc123 (æ‰€æœ‰ç”¨æˆ·å…±äº«åŒä¸€ä¸ª token)             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           StreamManager (æµç®¡ç†å™¨)                         â”‚   â”‚
â”‚  â”‚   Map<streamingId, Set<Response>>                         â”‚   â”‚
â”‚  â”‚   - streamingId_1 â†’ [User1's HTTP Response]              â”‚   â”‚
â”‚  â”‚   - streamingId_2 â†’ [User2's HTTP Response]              â”‚   â”‚
â”‚  â”‚   - streamingId_3 â†’ [User3's HTTP Response]              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚       ClaudeProcessManager (è¿›ç¨‹ç®¡ç†å™¨)                    â”‚   â”‚
â”‚  â”‚   Map<streamingId, ChildProcess>                          â”‚   â”‚
â”‚  â”‚   - streamingId_1 â†’ Claude Process A (PID: 1001)         â”‚   â”‚
â”‚  â”‚   - streamingId_2 â†’ Claude Process B (PID: 1002)         â”‚   â”‚
â”‚  â”‚   - streamingId_3 â†’ Claude Process C (PID: 1003)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‘¥ ä¸‰ä¸ªç”¨æˆ·åŒæ—¶è®¿é—®çš„å®Œæ•´æµç¨‹

### åœºæ™¯è®¾ç½®
- **ç”¨æˆ· A**: å¼ ä¸‰,æƒ³åˆ†æä»£ç 
- **ç”¨æˆ· B**: æå››,æƒ³é‡æ„é¡¹ç›®
- **ç”¨æˆ· C**: ç‹äº”,æƒ³å†™æµ‹è¯•

### æ—¶é—´çº¿

```
æ—¶é—´  â”‚ ç”¨æˆ· A (å¼ ä¸‰)                  â”‚ ç”¨æˆ· B (æå››)                 â”‚ ç”¨æˆ· C (ç‹äº”)
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
10:00 â”‚ è®¿é—® http://server:3001/     â”‚                              â”‚
      â”‚ #abc123                      â”‚                              â”‚
      â”‚                              â”‚                              â”‚
10:01 â”‚ å‘é€æ¶ˆæ¯: "åˆ†æä»£ç "          â”‚ è®¿é—® http://server:3001/    â”‚
      â”‚ â†“                            â”‚ #abc123                      â”‚
      â”‚ æœåŠ¡å™¨åˆ›å»º:                   â”‚                              â”‚
      â”‚ - streamingId: uuid-AAA      â”‚                              â”‚
      â”‚ - sessionId: sess_001        â”‚                              â”‚
      â”‚ - spawn Claude (PID: 1001)   â”‚                              â”‚
      â”‚                              â”‚                              â”‚
10:02 â”‚ æ”¶åˆ°æµå¼å“åº”...              â”‚ å‘é€æ¶ˆæ¯: "é‡æ„é¡¹ç›®"          â”‚ è®¿é—® http://server:3001/
      â”‚ {"type":"assistant"...}      â”‚ â†“                            â”‚ #abc123
      â”‚                              â”‚ æœåŠ¡å™¨åˆ›å»º:                   â”‚
      â”‚                              â”‚ - streamingId: uuid-BBB      â”‚
      â”‚                              â”‚ - sessionId: sess_002        â”‚
      â”‚                              â”‚ - spawn Claude (PID: 1002)   â”‚
      â”‚                              â”‚                              â”‚
10:03 â”‚ ç»§ç»­æ”¶åˆ°å“åº”...              â”‚ æ”¶åˆ°æµå¼å“åº”...              â”‚ å‘é€æ¶ˆæ¯: "å†™æµ‹è¯•"
      â”‚                              â”‚                              â”‚ â†“
      â”‚                              â”‚                              â”‚ æœåŠ¡å™¨åˆ›å»º:
      â”‚                              â”‚                              â”‚ - streamingId: uuid-CCC
      â”‚                              â”‚                              â”‚ - sessionId: sess_003
      â”‚                              â”‚                              â”‚ - spawn Claude (PID: 1003)
      â”‚                              â”‚                              â”‚
10:04 â”‚ âœ… å¯¹è¯å®Œæˆ                  â”‚ ç»§ç»­æ”¶åˆ°å“åº”...              â”‚ æ”¶åˆ°æµå¼å“åº”...
      â”‚ Claude è¿›ç¨‹ 1001 é€€å‡º        â”‚                              â”‚
      â”‚                              â”‚                              â”‚
10:05 â”‚ å¼€å§‹æ–°å¯¹è¯: "ç»§ç»­ä¼˜åŒ–"       â”‚ âœ… å¯¹è¯å®Œæˆ                  â”‚ ç»§ç»­æ”¶åˆ°å“åº”...
      â”‚ â†“                            â”‚ Claude è¿›ç¨‹ 1002 é€€å‡º        â”‚
      â”‚ æœåŠ¡å™¨åˆ›å»º:                   â”‚                              â”‚
      â”‚ - streamingId: uuid-DDD      â”‚                              â”‚
      â”‚ - sessionId: sess_004        â”‚                              â”‚
      â”‚ - spawn Claude (PID: 1004)   â”‚                              â”‚
      â”‚                              â”‚                              â”‚
```

---

## ğŸ”‘ å…³é”®éš”ç¦»æœºåˆ¶

### 1. **streamingId (æµæ ‡è¯†ç¬¦)**

æ¯ä¸ªå¯¹è¯éƒ½æœ‰å”¯ä¸€çš„ UUID:

```typescript
// ä» claude-process-manager.ts
const streamingId = uuidv4(); // ä¾‹å¦‚: "a1b2c3d4-e5f6-..."

// ç”¨äº:
// 1. æ ‡è¯† Claude å­è¿›ç¨‹
this.processes.set(streamingId, claudeProcess);

// 2. æ ‡è¯† HTTP æµè¿æ¥
this.streamManager.addClient(streamingId, response);

// 3. è·¯ç”±è¾“å‡ºåˆ°æ­£ç¡®çš„å®¢æˆ·ç«¯
this.streamManager.broadcast(streamingId, event);
```

### 2. **sessionId (ä¼šè¯æ ‡è¯†ç¬¦)**

Claude CLI ç”Ÿæˆçš„æ°¸ä¹…ä¼šè¯ ID:

```typescript
// Claude CLI è¿”å›çš„ç¬¬ä¸€æ¡æ¶ˆæ¯
{
  "type": "system",
  "subtype": "init",
  "session_id": "1234567890abcdef",  // â† Claude å†…éƒ¨ ID
  "cwd": "/path/to/project",
  "model": "claude-sonnet-4.5"
}

// ç”¨äº:
// 1. æ¢å¤å†å²å¯¹è¯
claude --resume 1234567890abcdef "ç»§ç»­èŠå¤©"

// 2. è¯»å–å¯¹è¯å†å²
~/.claude/sessions/1234567890abcdef/
```

### 3. **Auth Token (è®¤è¯ä»¤ç‰Œ)**

å•ä¸ª token,æ‰€æœ‰ç”¨æˆ·å…±äº«:

```typescript
// ä» auth.ts
const token = authHeader.substring(7); // æå– Bearer token
const expectedToken = ConfigService.getInstance().getConfig().authToken;

if (token !== expectedToken) {
  res.status(401).json({ error: 'Unauthorized' });
  return;
}
```

**é‡è¦:** è¿™æ˜¯**å•ç”¨æˆ·ç³»ç»Ÿ**!æ‰€æœ‰çŸ¥é“ token çš„äººå…±äº«åŒä¸€ä¸ªæœåŠ¡å™¨ã€‚

### 4. **StreamManager (æµç®¡ç†å™¨)**

è´Ÿè´£å°†æ­£ç¡®çš„è¾“å‡ºå‘é€ç»™æ­£ç¡®çš„å®¢æˆ·ç«¯:

```typescript
// ä» stream-manager.ts
class StreamManager {
  // å­˜å‚¨: streamingId â†’ Set<Response>
  private clients: Map<string, Set<Response>> = new Map();

  broadcast(streamingId: string, event: StreamEvent): void {
    const clients = this.clients.get(streamingId);
    if (!clients) return;

    // å‘é€ç»™æ‰€æœ‰ç›‘å¬è¿™ä¸ª streamingId çš„å®¢æˆ·ç«¯
    for (const client of clients) {
      this.sendSSEEvent(client, event);
    }
  }
}
```

---

## ğŸ¨ å¯è§†åŒ–ç¤ºä¾‹

### æœåŠ¡å™¨å†…éƒ¨çŠ¶æ€ (10:03 æ—¶åˆ»)

```javascript
// ProcessManager.processes
Map {
  "uuid-AAA" => ChildProcess { pid: 1001, ... },  // å¼ ä¸‰çš„è¿›ç¨‹
  "uuid-BBB" => ChildProcess { pid: 1002, ... },  // æå››çš„è¿›ç¨‹
  "uuid-CCC" => ChildProcess { pid: 1003, ... }   // ç‹äº”çš„è¿›ç¨‹
}

// StreamManager.clients
Map {
  "uuid-AAA" => Set [ Responseå¯¹è±¡A ],  // å¼ ä¸‰çš„ HTTP è¿æ¥
  "uuid-BBB" => Set [ Responseå¯¹è±¡B ],  // æå››çš„ HTTP è¿æ¥
  "uuid-CCC" => Set [ Responseå¯¹è±¡C ]   // ç‹äº”çš„ HTTP è¿æ¥
}
```

### ç³»ç»Ÿè¿›ç¨‹åˆ—è¡¨

```bash
$ ps aux | grep claude

user  1001  0.5  2.3  claude -p chat "åˆ†æä»£ç " ...        # å¼ ä¸‰çš„
user  1002  0.8  2.1  claude -p chat "é‡æ„é¡¹ç›®" ...        # æå››çš„
user  1003  0.3  1.9  claude -p chat "å†™æµ‹è¯•" ...          # ç‹äº”çš„
```

---

## âœ… éš”ç¦»ä¿è¯

### 1. **è¿›ç¨‹éš”ç¦»**
```
æ¯ä¸ªå¯¹è¯ = ç‹¬ç«‹çš„ Claude CLI è¿›ç¨‹
è¿›ç¨‹ A å´©æºƒ âŒ â†’ ä¸å½±å“è¿›ç¨‹ B å’Œ C âœ…
```

### 2. **æ•°æ®éš”ç¦»**
```
æ¯ä¸ª sessionId æœ‰ç‹¬ç«‹çš„ç›®å½•:
~/.claude/sessions/
â”œâ”€â”€ 1234567890abcdef/  (å¼ ä¸‰çš„å¯¹è¯)
â”‚   â”œâ”€â”€ conversation.jsonl
â”‚   â””â”€â”€ metadata.json
â”œâ”€â”€ 2345678901bcdefg/  (æå››çš„å¯¹è¯)
â”‚   â”œâ”€â”€ conversation.jsonl
â”‚   â””â”€â”€ metadata.json
â””â”€â”€ 3456789012cdefgh/  (ç‹äº”çš„å¯¹è¯)
    â”œâ”€â”€ conversation.jsonl
    â””â”€â”€ metadata.json
```

### 3. **æµè¾“å‡ºéš”ç¦»**
```typescript
// Claude è¿›ç¨‹ A è¾“å‡º â†’ åªå‘ç»™ uuid-AAA çš„å®¢æˆ·ç«¯
claudeProcess.stdout.on('data', (data) => {
  const streamingId = "uuid-AAA";
  this.streamManager.broadcast(streamingId, parsedEvent);
  // â†‘ åªå‘ç»™å¼ ä¸‰,ä¸ä¼šå‘ç»™æå››å’Œç‹äº”
});
```

### 4. **å·¥ä½œç›®å½•éš”ç¦»**
```typescript
// æ¯ä¸ªè¿›ç¨‹åœ¨ä¸åŒçš„ç›®å½•è¿è¡Œ
spawn('claude', args, {
  cwd: '/home/user/project-A'  // å¼ ä¸‰çš„é¡¹ç›®
});

spawn('claude', args, {
  cwd: '/home/user/project-B'  // æå››çš„é¡¹ç›®
});

spawn('claude', args, {
  cwd: '/home/user/project-C'  // ç‹äº”çš„é¡¹ç›®
});
```

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### å½“å‰è®¾è®¡: å•ç”¨æˆ·å¤šä¼šè¯

```
ä¸€ä¸ª Auth Token â†’ å¤šä¸ªäººå…±äº« â†’ æ‰€æœ‰äººçœ‹åˆ°ç›¸åŒçš„:
- æ–‡ä»¶ç³»ç»Ÿ
- å¯¹è¯å†å²åˆ—è¡¨
- API keys
```

**é€‚ç”¨åœºæ™¯:**
- âœ… ä¸ªäººä½¿ç”¨ (å¤šä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µ)
- âœ… å›¢é˜Ÿå…±äº« (ä¿¡ä»»çš„å›¢é˜Ÿæˆå‘˜)
- âŒ å…¬å¼€æœåŠ¡ (éœ€è¦å¤šç”¨æˆ·ç³»ç»Ÿ)

### å¦‚æœè¦æ”¯æŒçœŸæ­£çš„å¤šç”¨æˆ·

éœ€è¦æ·»åŠ :
```typescript
// 1. ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
interface User {
  id: string;
  username: string;
  password: string;  // hashed
  sessions: string[];  // åªèƒ½è®¿é—®è‡ªå·±çš„ sessions
}

// 2. åŸºäºç”¨æˆ·çš„ token
authToken = `user_${userId}_${randomToken}`;

// 3. æ•°æ®éš”ç¦»
~/.cui/users/
â”œâ”€â”€ user_zhang/
â”‚   â””â”€â”€ sessions/
â”œâ”€â”€ user_li/
â”‚   â””â”€â”€ sessions/
â””â”€â”€ user_wang/
    â””â”€â”€ sessions/
```

---

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### å¹¶å‘é™åˆ¶

```typescript
// æ¯ä¸ª Claude è¿›ç¨‹å ç”¨èµ„æº:
- CPU: ~10-20%
- Memory: ~200-500 MB
- ç½‘ç»œ: æŒç»­ API è°ƒç”¨

// æœåŠ¡å™¨æ‰¿è½½èƒ½åŠ›ç¤ºä¾‹:
4 æ ¸ 8GB RAM æœåŠ¡å™¨ â†’ çº¦ 10-15 ä¸ªå¹¶å‘å¯¹è¯
8 æ ¸ 16GB RAM æœåŠ¡å™¨ â†’ çº¦ 30-50 ä¸ªå¹¶å‘å¯¹è¯
```

### èµ„æºæ¸…ç†

```typescript
// å¯¹è¯ç»“æŸåè‡ªåŠ¨æ¸…ç†
claudeProcess.on('close', (code) => {
  this.processes.delete(streamingId);  // åˆ é™¤è¿›ç¨‹å¼•ç”¨
  this.outputBuffers.delete(streamingId);  // æ¸…ç†ç¼“å†²åŒº
  this.streamManager.removeClient(streamingId, response);  // å…³é—­è¿æ¥
});
```

---

## ğŸ¯ æ€»ç»“

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| æ”¯æŒå¤šç”¨æˆ·åŒæ—¶è®¿é—®? | âœ… æ˜¯çš„ |
| èƒ½åŒºåˆ†ä¸åŒç”¨æˆ·çš„å¯¹è¯? | âœ… æ¯ä¸ªå¯¹è¯æœ‰å”¯ä¸€çš„ streamingId |
| å¯¹è¯ä¹‹é—´äº’ä¸å¹²æ‰°? | âœ… ç‹¬ç«‹è¿›ç¨‹ + ç‹¬ç«‹æ•°æ® + ç‹¬ç«‹æµ |
| æ”¯æŒå¤šç”¨æˆ·è´¦å·ç³»ç»Ÿ? | âŒ å½“å‰æ˜¯å• token å…±äº«æ¨¡å¼ |
| ä¸€ä¸ªç”¨æˆ·å¯ä»¥å¤šä¸ªå¯¹è¯? | âœ… å¯ä»¥,æ¯ä¸ªå¯¹è¯ç‹¬ç«‹ |
| å¯¹è¯å¯ä»¥åå°è¿è¡Œ? | âœ… å¯ä»¥å…³é—­æµè§ˆå™¨,è¿›ç¨‹ç»§ç»­æ‰§è¡Œ |

---

## ğŸ”¬ éªŒè¯æ–¹æ³•

æƒ³äº²è‡ªéªŒè¯?è¯•è¯•è¿™ä¸ª:

```bash
# ç»ˆç«¯ 1: å¯åŠ¨æœåŠ¡å™¨
npm run dev

# ç»ˆç«¯ 2: å¼€å§‹å¯¹è¯ A
curl -X POST http://localhost:3001/api/conversations/start \
  -H "Authorization: Bearer abc123" \
  -H "Content-Type: application/json" \
  -d '{"message": "åˆ†æä»£ç ", "workingDirectory": "/tmp/project-a"}'

# ç»ˆç«¯ 3: åŒæ—¶å¼€å§‹å¯¹è¯ B
curl -X POST http://localhost:3001/api/conversations/start \
  -H "Authorization: Bearer abc123" \
  -H "Content-Type: application/json" \
  -d '{"message": "å†™æµ‹è¯•", "workingDirectory": "/tmp/project-b"}'

# ç»ˆç«¯ 4: æŸ¥çœ‹è¿›ç¨‹
ps aux | grep claude
# ä½ ä¼šçœ‹åˆ°ä¸¤ä¸ªç‹¬ç«‹çš„ claude è¿›ç¨‹!
```
